default:
  image: docker.io/zazukoians/node-java-jena:v4

stages:
  - fetch
  - process

# fetch files from S3 bucket and merge them
fetch:
  stage: fetch
  image:
    name: docker.io/minio/mc:latest
    entrypoint: [""]
  artifacts:
    untracked: true
  script:
    - mc alias set bucket "${S3_ENDPOINT}" "${S3_ACCESS_KEY}" "${S3_SECRET_KEY}"
    - mkdir -p input
    - mc cp -r "bucket/${S3_BUCKET}/${S3_PATH}/" input
    - ls -alh input
    - jq -s 'flatten' input/*.json > input/input.json

# run the pipeline
process:
  stage: process
  dependencies:
    - fetch
  artifacts:
    paths:
      - output/
  services:
    - name: ghcr.io/zazuko/carml-service:v0.0.3
      alias: carml-service
  variables:
    CARML_SERVICE: "http://carml-service:8080/"
  script:
    - npm ci
    - npm run start
